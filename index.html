<script>
    let cy, currentNodeId, ring1, ring2, ring3, visibleRing3;
    let radius1 = 200, radius2 = 500, radius3 = 800;

    function getBestPrimary(node, primaryIds) {
      const scoreMap = {};
      node.connectedEdges().forEach(edge => {
        const source = edge.source().id();
        const target = edge.target().id();
        const neighbor = source === node.id() ? target : source;
        if (primaryIds.has(neighbor)) {
          scoreMap[neighbor] = (scoreMap[neighbor] || 0) + 1;
        }
      });
      return Object.entries(scoreMap).sort((a, b) => b[1] - a[1])[0]?.[0] || '';
    }

    function updateDepth() {
      if (currentNodeId) {
        const node = cy.getElementById(currentNodeId);
        if (node && node.length > 0) {
          highlightNode(node);
        }
      }
    }

    function focusOnNode(id) {
      const node = cy.getElementById(id);
      if (node && node.length > 0) {
        highlightNode(node);
      } else {
        alert('Node not found');
      }
    }

    fetch('graph.json')
      .then(res => res.json())
      .then(graphData => {
        cy = cytoscape({
          container: document.getElementById('cy'),
          elements: [...graphData.nodes, ...graphData.edges],
          style: [
            {
              selector: 'node',
              style: {
                'label': 'data(label)',
                'background-color': ele => {
                  const type = ele.data('type');
                  const colors = {
                    Individual: '#1f77b4',
                    Campaign: '#d62728',
                    Group: '#9467bd',
                    Institution: '#2ca02c',
                    Policy: '#ff7f0e',
                    Event: '#8c564b',
                    Media: '#17becf',
                    Place: '#7f7f7f'
                  };
                  return colors[type] || '#ccc';
                },
                'text-valign': 'center',
                'text-halign': 'center',
                'color': '#fff',
                'text-outline-width': 1,
                'text-outline-color': '#000',
                'width': 30,
                'height': 30
              }
            },
            {
              selector: 'edge',
              style: {
                'label': 'data(label)',
                'curve-style': 'bezier',
                'target-arrow-shape': 'triangle',
                'line-color': '#aaa',
                'target-arrow-color': '#aaa',
                'font-size': 10,
                'text-rotation': 'autorotate',
                'text-margin-y': -8
              }
            },
            {
              selector: '.faded',
              style: {
                'opacity': 0.1,
                'text-opacity': 0.05
              }
            },
            {
              selector: '.hidden',
              style: {
                'display': 'none'
              }
            },
            {
              selector: '.faded-third',
              style: {
                'opacity': 0.2,
                'text-opacity': 0.1
              }
            }
          ],
          layout: { name: 'preset' },
          minZoom: 0.2,
          maxZoom: 3
        });

        cy.on('tap', 'node', function(evt) {
          const node = evt.target;
          if (node) {
            highlightNode(node);
          }
        });

        cy.ready(() => {
          const defaultNode = cy.getElementById('individual_0');
          if (defaultNode && defaultNode.length > 0) {
            highlightNode(defaultNode);
          }
        });
      });
</script>